AWSTemplateFormatVersion: '2010-09-09'
Description: Stack de CloudFormation para desplegar instancias Amazon Linux 2, Windows Server y Ubuntu.

Parameters:
  KeyName:
    Description: Nombre de la llave SSH para acceso a las instancias
    Type: 'AWS::EC2::KeyPair::KeyName'
    ConstraintDescription: Debe ser el nombre de una llave SSH existente.
  VpcId:
    Description: ID de la VPC donde se desplegar치n los recursos
    Type: 'AWS::EC2::VPC::Id'
    ConstraintDescription: Debe ser un ID de VPC v치lido.
  SubnetId:
    Description: ID de la subred donde se desplegar치n las instancias
    Type: 'AWS::EC2::Subnet::Id'
    ConstraintDescription: Debe ser un ID de subred v치lido en la VPC especificada.

Resources:
  InstanceSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupDescription: Permitir acceso SSH y RDP
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '3389'
          ToPort: '3389'
          CidrIp: 0.0.0.0/0

  LinuxInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: 't2.micro'
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !GetAtt InstanceSecurityGroup.GroupId
      SubnetId: !Ref SubnetId
      ImageId: 'ami-0e472ba40eb589f49'  # Amazon Linux 2
      Tags:
        - Key: Name
          Value: LinuxInstance

  WindowsInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: 't2.micro'
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !GetAtt InstanceSecurityGroup.GroupId
      SubnetId: !Ref SubnetId
      ImageId: 'ami-0b69ea66ff7391e80'  # Windows Server 2019
      Tags:
        - Key: Name
          Value: WindowsInstance

  UbuntuInstance:
    Type: 'AWS::EC2::Instance'
    Properties:
      InstanceType: 't2.micro'
      KeyName: !Ref KeyName
      SecurityGroupIds:
        - !GetAtt InstanceSecurityGroup.GroupId
      SubnetId: !Ref SubnetId
      ImageId: 'ami-042e8287309f5df03'  # Ubuntu 20.04 LTS
      Tags:
        - Key: Name
          Value: UbuntuInstance
